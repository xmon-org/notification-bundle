#!/bin/bash

# Pre-commit hook: ejecuta PHP-CS-Fixer y PHPStan antes de cada commit

set -e

echo "üîç Pre-commit checks..."

# Verificar si vendor existe
if [ ! -d "vendor" ]; then
    echo "‚ö†Ô∏è  vendor/ no existe. Ejecuta 'composer install' primero."
    exit 1
fi

# Obtener archivos PHP staged
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep '\.php$' || true)

if [ -z "$STAGED_FILES" ]; then
    echo "‚úÖ No hay archivos PHP staged, saltando validaciones."
    exit 0
fi

# 1. PHP-CS-Fixer (auto-fix)
echo "üîß Ejecutando PHP-CS-Fixer..."
echo "$STAGED_FILES" | xargs vendor/bin/php-cs-fixer fix --config=.php-cs-fixer.dist.php --quiet

# Re-a√±adir los archivos arreglados al stage
echo "$STAGED_FILES" | xargs git add

# 2. PHPStan (solo archivos modificados)
echo "üîç Ejecutando PHPStan en archivos modificados..."

# Filtrar solo archivos que existen en src/ o tests/
ANALYZED_FILES=$(echo "$STAGED_FILES" | grep -E '^(src|tests)/' || true)

if [ -n "$ANALYZED_FILES" ]; then
    # Ejecutar PHPStan solo en archivos modificados
    if ! echo "$ANALYZED_FILES" | xargs vendor/bin/phpstan analyse --no-progress --error-format=table; then
        echo ""
        echo "‚ùå PHPStan encontr√≥ errores. Por favor corr√≠gelos antes de commitear."
        echo "üí° Ejecuta 'composer phpstan' para ver todos los errores."
        exit 1
    fi
else
    echo "‚è≠Ô∏è  No hay archivos en src/ o tests/ para analizar."
fi

echo "‚úÖ Pre-commit checks completados."
exit 0
